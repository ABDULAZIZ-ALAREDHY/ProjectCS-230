import java.util.ArrayList;
import java.util.InputMismatchException;
import java.util.Scanner;

/**
 * Main application class for the University Management Program.
 * Manages the records and user interaction via a simple menu.
 */
public class Main {

    private static final Scanner scanner = new Scanner(System.in);

    /**
     * The program's entry point, running the main menu loop.
     * @param args Command line arguments (not used).
     */
    public static void main(String[] args) {

        ArrayList<Person> records = new ArrayList<>();
        int choice;

        System.out.println("=======================================");
        System.out.println("    Saudi Electronic University Management Program (CS230)");
        System.out.println("=======================================");

        while (true) {
            System.out.println("\nSelect one of the options below:");
            System.out.println("1. Add New Student");
            System.out.println("2. Add Full-Time Employee");
            System.out.println("3. Add Part-Time Employee");
            System.out.println("4. View All Records");
            System.out.println("5. Exit Program");
            System.out.print("Your choice: ");

            try {
                choice = scanner.nextInt();
                scanner.nextLine();
            } catch (InputMismatchException e) {
                System.out.println("\nâŒ Error: You must enter a number for the option.");
                scanner.nextLine(); // Clear the invalid input
                continue;
            }

            switch (choice) {
                case 1:
                    addStudent(records);
                    break;
                case 2:
                    addFullTimeEmployee(records);
                    break;
                case 3:
                    addPartTimeEmployee(records);
                    break;
                case 4:
                    displayAllRecords(records);
                    break;
                case 5:
                    System.out.println("\nâœ… Thank you, goodbye.");
                    scanner.close();
                    return;
                default:
                    System.out.println("\nâŒ Error: The number you entered is not in the options.");
            }
        }
    }

    /**
     * Prompts for and creates a new Student object.
     * The ID uniqueness is checked only against other Student records.
     * @param records The list to add the new student to.
     */
    public static void addStudent(ArrayList<Person> records) {
        System.out.println("\n--- Enter New Student Data ---");

        String name = getValidNameInput("Enter student name: ");
        // ğŸ”‘ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªÙ…Ø±ÙŠØ± Student.class Ù„Ø¶Ù…Ø§Ù† ÙØ±Ø§Ø¯Ø© ID Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙ‚Ø· Ø¨ÙŠÙ† Ø§Ù„Ø·Ù„Ø§Ø¨
        int id = getUniqueIdInput("Enter the unique ID: ", records, Student.class);

        System.out.print("Enter course name: ");
        String course = scanner.nextLine();

        double grade = getValidGradeInput("Enter the grade (between 0-100): ");

        Student newStudent = new Student(name, id, course, grade);
        records.add(newStudent);
        System.out.println("\nâœ… Student " + name + " recorded successfully.");
    }

    /**
     * Prompts for and creates a new FullTimeEmployee object.
     * The ID uniqueness is checked against all Employee records (Full-Time and Part-Time).
     * @param records The list to add the new employee to.
     */
    public static void addFullTimeEmployee(ArrayList<Person> records) {
        System.out.println("\n--- Enter Full-Time Employee Data ---");

        String name = getValidNameInput("Enter employee name: ");
        // ğŸ”‘ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªÙ…Ø±ÙŠØ± Employee.class Ù„Ø¶Ù…Ø§Ù† ÙØ±Ø§Ø¯Ø© ID Ø§Ù„Ù…ÙˆØ¸Ù Ø¨ÙŠÙ† ÙƒÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
        int id = getUniqueIdInput("Enter the unique ID: ", records, Employee.class);

        double monthlySalary = getValidDoubleInput("Enter monthly salary (must be positive): ");

        if (monthlySalary != -1) { 
            FullTimeEmployee newFTE = new FullTimeEmployee(name, id, monthlySalary);
            records.add(newFTE);
            System.out.println("\nâœ… Employee " + name + " recorded successfully.");
        }
    }

    /**
     * Prompts for and creates a new PartTimeEmployee object.
     * The ID uniqueness is checked against all Employee records (Full-Time and Part-Time).
     * @param records The list to add the new employee to.
     */
    public static void addPartTimeEmployee(ArrayList<Person> records) {
        System.out.println("\n--- Enter Part-Time Employee Data ---");

        String name = getValidNameInput("Enter employee name: ");
        // ğŸ”‘ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªÙ…Ø±ÙŠØ± Employee.class Ù„Ø¶Ù…Ø§Ù† ÙØ±Ø§Ø¯Ø© ID Ø§Ù„Ù…ÙˆØ¸Ù Ø¨ÙŠÙ† ÙƒÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
        int id = getUniqueIdInput("Enter the unique ID: ", records, Employee.class);

        double hourlyRate = getValidDoubleInput("Enter hourly rate (must be positive): ");

        int hoursWorked = getValidIntegerInput("Enter number of hours worked (must be positive): ");

        if (hourlyRate != -1 && hoursWorked != -1) {
            PartTimeEmployee newPTE = new PartTimeEmployee(name, id, hourlyRate, hoursWorked);
            records.add(newPTE);
            System.out.println("\nâœ… Employee " + name + " recorded successfully.");
        }
    }

    /**
     * Iterates through all records, displays details using polymorphism, and shows statistics.
     * @param records The list of all Person records.
     */
    public static void displayAllRecords(ArrayList<Person> records) {
        if (records.isEmpty()) {
            System.out.println("\nğŸ’¡ There are currently no records to display.");
            return;
        }

        int fullTimeCount = 0;
        int partTimeCount = 0;
        int studentCount = 0;
        int totalEmployees = 0;

        System.out.println("\n=========== All Existing Records (" + records.size() + ") ===========");

        for (Person member : records) {
            member.displayDetails();

            if (member instanceof FullTimeEmployee) {
                FullTimeEmployee emp = (FullTimeEmployee) member;
                System.out.println("Calculated Salary: " + emp.calculateSalary() + " Riyal");
                fullTimeCount++;
                totalEmployees++;
                System.out.println("========================================");
            } else if (member instanceof PartTimeEmployee) {
                PartTimeEmployee emp = (PartTimeEmployee) member;
                System.out.println("Calculated Salary: " + emp.calculateSalary() + " Riyal");
                partTimeCount++;
                totalEmployees++;
                System.out.println("========================================");
            } else if (member instanceof Student) {
                studentCount++;
                System.out.println("========================================");
            }
        }

        System.out.println("\nğŸ“Š Current Statistics Summary:");
        System.out.println("  - Total Number of Records: " + records.size());
        System.out.println("  - Number of Registered Students: " + studentCount);
        System.out.println("  - Number of Full-Time Employees: " + fullTimeCount);
        System.out.println("  - Number of Part-Time Employees: " + partTimeCount);
        System.out.println("  - Total Number of Employees: " + totalEmployees);
        System.out.println("========================================");

        if (totalEmployees > 0 && studentCount > 0) {
            System.out.println("\nâœ¨ Statistical Note: We have recorded both employees and students, our system is working well.");
        } else if (totalEmployees > 0) {
            System.out.println("\nâœ¨ Statistical Note: Existing records are for employees only.");
        } else if (studentCount > 0) {
            System.out.println("\nâœ¨ Statistical Note: Existing records are for students only.");
        }
    }

    /**
     * Prompts for a name and ensures it contains only letters and spaces.
     * @param prompt The message to display.
     * @return A validated name string.
     */
    public static String getValidNameInput(String prompt) {
        String name = "";
        while (true) {
            System.out.print(prompt);
            name = scanner.nextLine();
            if (name.matches("^[a-zA-Z\\u0600-\\u06FF\\s]+$") && !name.trim().isEmpty()) {
                break;
            } else {
                System.out.println("âš ï¸ Error: Name must contain only letters and spaces.");
            }
        }
        return name;
    }

    /**
     * Prompts for a grade and ensures it is a number between 0 and 100.
     * @param prompt The message to display.
     * @return A validated grade value.
     */
    public static double getValidGradeInput(String prompt) {
        double grade = -1;
        while (grade == -1) {
            System.out.print(prompt);
            try {
                grade = scanner.nextDouble();
                scanner.nextLine();
                if (grade < 0 || grade > 100) {
                    System.out.println("âš ï¸ Error: Grade must be between 0 and 100.");
                    grade = -1;
                }
            } catch (InputMismatchException e) {
                System.out.println("âš ï¸ Error: You must enter a number.");
                scanner.nextLine();
            }
        }
        return grade;
    }

    /**
     * Checks if the given ID is unique within the list for a specific entity type.
     * @param id The ID to check for uniqueness.
     * @param records The list of all Person records.
     * @param entityType The Class type (e.g., Student.class or Employee.class) being checked.
     * @return true if the ID is unique for its type, false otherwise.
     */
    public static boolean isIdUnique(int id, ArrayList<Person> records, Class<?> entityType) {
        for (Person member : records) {
            // Check if the member is of the same type AND has the same ID.
            if (entityType.isInstance(member) && member.getId() == id) {
                return false; // ID already exists for this type of entity
            }
        }
        return true; // ID is unique for this type
    }

    /**
     * Prompts for an ID, ensuring it is positive, an integer, and unique for its type.
     * @param prompt The message to display.
     * @param records The list of all Person records.
     * @param entityType The Class type being added (e.g., Student.class).
     * @return A unique and valid integer ID.
     */
    public static int getUniqueIdInput(String prompt, ArrayList<Person> records, Class<?> entityType) {
        int input = -1;
        while (input == -1) {
            System.out.print(prompt);
            try {
                input = scanner.nextInt();
                scanner.nextLine();
                if (input < 0) {
                    System.out.println("âš ï¸ Error: Value must be positive.");
                    input = -1;
                } 
                else if (!isIdUnique(input, records, entityType)) {
                    System.out.println("âŒ ID " + input + " is already in use by a member of this type. Please enter a unique ID.");
                    input = -1; 
                }
            } catch (InputMismatchException e) {
                System.out.println("âš ï¸ Error: The ID must be an integer (no decimals).");
                scanner.nextLine();
            }
        }
        return input;
    }

    /**
     * Prompts for an integer input and ensures it is positive.
     * @param prompt The message to display.
     * @return A valid positive integer.
     */
    public static int getValidIntegerInput(String prompt) {
        int input = -1;
        while (input == -1) {
            System.out.print(prompt);
            try {
                input = scanner.nextInt();
                scanner.nextLine();
                if (input < 0) {
                    System.out.println("âš ï¸ Error: Value must be positive.");
                    input = -1;
                }
            } catch (InputMismatchException e) {
                System.out.println("âš ï¸ Error: The value must be an integer (no decimals).");
                scanner.nextLine();
            }
        }
        return input;
    }

    /**
     * Prompts for a double input and ensures it is positive or zero.
     * @param prompt The message to display.
     * @return A valid positive double value.
     */
    public static double getValidDoubleInput(String prompt) {
        double input = -1;
        while (input == -1) {
            System.out.print(prompt);
            try {
                input = scanner.nextDouble();
                scanner.nextLine();
                if (input < 0) {
                    System.out.println("âš ï¸ Error: Value must be positive or zero.");
                    input = -1;
                }
            } catch (InputMismatchException e) {
                System.out.println("âš ï¸ Error: The value must be a number.");
                scanner.nextLine();
            }
        }
        return input;
    }
}
